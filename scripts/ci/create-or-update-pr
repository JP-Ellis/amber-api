#!/bin/bash
set -euo pipefail

################################################################################
## Create or Update Release PR
##
## Creates a new release PR or updates an existing one with the current
## version and changelog.
##
## Usage:
##   ./create-or-update-pr
##
## Environment Variables:
##   GH_TOKEN    Required for gh CLI authentication
##
## Exit Codes:
##   0 - Success
##   255 - Command failure
################################################################################

# Source CI utilities
# shellcheck source=scripts/ci/lib.sh
source "$(dirname "$0")/lib.sh"
# shellcheck source=scripts/version.sh
source "${CI_REPO_ROOT}/scripts/version.sh"

info "Creating or updating release PR"

# Assert gh CLI is authenticated
assert_cmd gh
if ! gh auth status >/dev/null 2>&1; then
  err "gh CLI not authenticated (set GH_TOKEN environment variable)"
fi

# Extract version from Cargo.toml
VERSION=$(get_current_version)
info "Release version: $VERSION"

# Extract changelog for PR body using git-cliff
TAG_NAME=$(format_tag_name "$VERSION")
PREV_TAG=$(git tag -l "${TAG_PREFIX}*" | grep -v "^${TAG_NAME}$" | sort -V | tail -n1 || echo "")

if [ -n "$PREV_TAG" ]; then
  CHANGELOG=$(git-cliff "${PREV_TAG}..HEAD" --strip all 2>/dev/null || echo "See CHANGELOG.md")
else
  CHANGELOG=$(git-cliff --strip all 2>/dev/null || echo "See CHANGELOG.md")
fi

# Build PR body
PR_BODY=$(
  cat <<EOF
## Release v${VERSION}

This PR prepares the release for version ${VERSION}.

### Changes

${CHANGELOG}

### Checklist

- [ ] Changelog is accurate and complete
- [ ] Version bump is correct
- [ ] All CI checks pass

> [!WARNING]
>
> If any changes are needed, please make them in this PR by _amending_ the commit.
> Do not create additional commits, or change the wording of the commit message, as this will interfere with the release process.

---
_This PR is automatically maintained by the release automation._
EOF
)

# Check if PR already exists
if gh pr view release --json number >/dev/null 2>&1; then
  info "Updating existing PR"
  ensure gh pr edit release \
    --title "Release v${VERSION}" \
    --body "$PR_BODY"
  info "Updated PR for release v${VERSION}"
else
  info "Creating new PR"
  ensure gh pr create \
    --base main \
    --head release \
    --title "Release v${VERSION}" \
    --body "$PR_BODY"
  info "Created PR for release v${VERSION}"
fi
